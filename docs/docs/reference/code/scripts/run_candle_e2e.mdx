---
title: "scripts/run_candle_e2e.sh"
---

This page is an **annotated source reference**. Code blocks are imported from the repository at build time.

## What this file is

`scripts/run_candle_e2e.sh` is an end-to-end harness for candle publishing and persistence.

It:

- builds the C++ candle engine (`state/candle_cpp`)
- starts the Go candle materializer (`cmd/candles`) to read candle subjects and write to ClickHouse
- replays a CSV of trade events using `candle_replay`
- stops the materializer and prints how many candle rows were inserted

## Why this file exists

Candles cross language and process boundaries:

- C++ engine aggregates and publishes candles
- JetStream transports them
- Go materializer consumes and writes to sinks

This script validates that the whole chain works in a local environment.

## Related docs

- Guides: [Quickstart (local dev)](../../../start-here/quickstart) and [Ops: local dev](../../../ops/local-dev)
- Architecture: [Canonical event model](../../../architecture/events) and [NATS / JetStream design](../../../architecture/nats)
- Engine + tools: [`state/candle_cpp/`](../state/candle_cpp) and [`state/candle_cpp/tools/candle_replay.cpp`](../state/candle_cpp/tools/candle_replay)
- Materializer: [`cmd/candles/main.go`](../cmd/candles/main)

## Full source

```bash title="scripts/run_candle_e2e.sh" file=<rootDir>/scripts/run_candle_e2e.sh showLineNumbers
```

## Walkthrough (by block)

### Configuration defaults + timeout command detection

```bash title="Configuration defaults + timeout command detection" file=<rootDir>/scripts/run_candle_e2e.sh#L1-L32 showLineNumbers
```

**What:** Sets defaults for NATS/ClickHouse parameters and ensures a usable `timeout` binary exists.

**How:** On macOS, it tries to add GNU coreutils to PATH; then chooses `timeout` or `gtimeout`.

**Why:** The replay command should not hang indefinitely; a portable timeout strategy helps run this script on common dev machines.

### ClickHouse client resolution + toolchain discovery

```bash title="ClickHouse client resolution + toolchain discovery" file=<rootDir>/scripts/run_candle_e2e.sh#L34-L80 showLineNumbers
```

**What:** Ensures ClickHouse tooling exists and configures CMake to find Protobuf/Abseil if needed.

**How:** Falls back to docker exec for ClickHouse. Detects Protobuf/Abseil paths and builds up `CMAKE_ARGS`.

**Why:** Candle E2E runs are common during onboarding; these helpers reduce setup work.

### Build candle engine + prepare ClickHouse table

```bash title="Build candle engine + prepare ClickHouse table" file=<rootDir>/scripts/run_candle_e2e.sh#L82-L88 showLineNumbers
```

**What:** Builds the candle engine and prepares a ClickHouse table to receive output.

**How:** Runs CMake configure/build and creates/truncates a simple `candles` table.

**Why:** Ensures the sink target is clean so the final count reflects only the current run.

### Run Go candle materializer + replay trades

```bash title="Run Go candle materializer + replay trades" file=<rootDir>/scripts/run_candle_e2e.sh#L90-L112 showLineNumbers
```

**What:** Starts the Go materializer and replays trades through the C++ engine publisher.

**How:**

- Runs `go run ./cmd/candles` in the background consuming `${SUBJECT_ROOT}.candle.>`
- Uses `timeout` to bound the replay run
- Stops the materializer after a short settle period

**Why:** This exercises the cross-process boundary (JetStream) and validates that the Go consumer can persist candle messages.

### Print results (and optional S3 listing)

```bash title="Print results (and optional S3 listing)" file=<rootDir>/scripts/run_candle_e2e.sh#L113-L117 showLineNumbers
```

**What:** Prints the ClickHouse row count and optionally lists Parquet objects if configured.

**How:** Queries ClickHouse for candle row count; when AWS CLI + Parquet env vars are present, lists objects from the bucket.

**Why:** These outputs provide immediate validation signals without requiring manual ClickHouse/S3 inspection.
