---
title: "sinks/nats/publisher.go"
---

This page is an **annotated source reference**. Code blocks are imported from the repository at build time.

## What this file is

`sinks/nats/publisher.go` implements a **canonical event publisher** for NATS JetStream.

It wraps:

- a NATS connection (`*nats.Conn`)
- a JetStream context (`nats.JetStreamContext`)

and exposes typed helpers to publish protobuf messages (`SwapEvent`, `BlockHead`, `TxMeta`, `PoolSnapshot`, `Candle`) to the repo’s subject conventions with deterministic-ish message IDs.

## Why this file exists

Publishing to JetStream has a few recurring requirements:

- consistent subject naming (`<root>.<program>.swap`, `<root>.blocks.head`, …)
- consistent headers (`Content-Type`, `Nats-Msg-Id` for dedupe)
- consistent timeout behavior (avoid hanging publishes)
- consistent stream expectations (publish into the configured stream)

Centralizing these rules reduces duplicated “publish boilerplate” across ingestors/tools and makes correctness constraints reviewable in one place.

## TL;DR

- **Purpose:** Publish canonical protobuf events to JetStream with stable subject conventions and dedupe headers.
- **Subjects:** e.g. `dex.sol.<program>.swap`, `dex.sol.blocks.head`, `dex.sol.candle.<scope>.<timeframe>`.
- **Deduping:** sets `Nats-Msg-Id` to support replay/backfill without duplicates (within `duplicate_window`).
- **Main risk area:** message-id and subject conventions are part of the pipeline contract; changes here ripple to sinks and schema consumers.

## Full source

```go title="sinks/nats/publisher.go" file=<rootDir>/sinks/nats/publisher.go showLineNumbers
```

## Walkthrough (by declaration)

### package natsx

```go title="package natsx" file=<rootDir>/sinks/nats/publisher.go#L1-L1 showLineNumbers
```

**What:** Declares the publisher implementation in the shared `natsx` package.

**How:** Producers construct a `Publisher` via `NewPublisher(cfg)` and call the typed `Publish*` helpers.

**Why:** A single publishing implementation prevents subject/message-id drift across producers.

### imports

```go title="imports" file=<rootDir>/sinks/nats/publisher.go#L3-L13 showLineNumbers
```

**What:** Publisher dependencies: context/timeouts, protobuf encoding, NATS client, and canonical message types.

**How:**

- `proto.Marshal` encodes messages into bytes.
- `nats.Msg` headers are used for `Nats-Msg-Id` and content type.

**Why:** Publishing is “format + routing + reliability”; these imports cover those concerns.

### type (Publisher)

**Symbols:** Publisher

```go title="type (Publisher)" file=<rootDir>/sinks/nats/publisher.go#L15-L20 showLineNumbers
```

**What:** `Publisher` is a stateful wrapper around a JetStream connection.

**How:** It stores:

- the validated `Config` (URL/stream/root/timeout)
- the underlying `*nats.Conn` (for draining/closing)
- the JetStream context used to publish

**Why:** The publisher is used in long-running services and should manage connection lifecycle explicitly.

### func NewPublisher

**Symbols:** NewPublisher

```go title="func NewPublisher" file=<rootDir>/sinks/nats/publisher.go#L22-L41 showLineNumbers
```

**What:** Constructs a publisher by validating config, dialing NATS, and creating a JetStream context.

**How:**

1. Validate config (required fields, sane timeout).
2. `nats.Connect(cfg.URL, ...)` with a client name.
3. `conn.JetStream()` to obtain the publishing context.

If JetStream context creation fails, the connection is closed to avoid leaking resources.

**Why:** All publish helpers assume JetStream is available; construction is the right place to enforce that invariant.

### func (*Publisher) Close

**Symbols:** Close

```go title="func (*Publisher) Close" file=<rootDir>/sinks/nats/publisher.go#L43-L50 showLineNumbers
```

**What:** Shuts down the publisher’s connection to NATS.

**How:** Uses `Drain()` (best-effort) to flush pending traffic, then closes the connection.

**Why:** Long-running services should release resources cleanly on shutdown and avoid dropping in-flight publishes.

### func (*Publisher) PublishSwap

**Symbols:** PublishSwap

```go title="func (*Publisher) PublishSwap" file=<rootDir>/sinks/nats/publisher.go#L52-L60 showLineNumbers
```

**What:** Publishes a `dexv1.SwapEvent` to `<subjectRoot>.<program>.swap`.

**How:**

- Subject segment is derived from `programSegment(programID)` so consumers can filter by DEX.
- A message ID is constructed from slot/sig/index (currently with a hard-coded `501` chain ID prefix).
- Delegates to `publish(...)` to apply headers, timeouts, and stream expectations.

**Why:** Swaps are the highest-volume canonical events; providing a dedicated helper avoids repeated subject/id boilerplate and enforces consistent routing.

### func (*Publisher) PublishBlockHead

**Symbols:** PublishBlockHead

```go title="func (*Publisher) PublishBlockHead" file=<rootDir>/sinks/nats/publisher.go#L62-L70 showLineNumbers
```

**What:** Publishes `dexv1.BlockHead` updates to `<subjectRoot>.blocks.head`.

**How:** Uses the slot as the message ID key (again with `501:` prefix) and delegates to `publish(...)`.

**Why:** Block heads are used by consumers to map `slot -> timestamp` and to detect “dead” slots; publishing them centrally helps sinks reconstruct time.

### func (*Publisher) PublishTxMeta

**Symbols:** PublishTxMeta

```go title="func (*Publisher) PublishTxMeta" file=<rootDir>/sinks/nats/publisher.go#L72-L80 showLineNumbers
```

**What:** Publishes transaction metadata (`dexv1.TxMeta`) to `<subjectRoot>.tx.meta`.

**How:** Uses `slot + sig` as the message ID and delegates to `publish(...)`.

**Why:** Tx metadata is a low-frequency enrichment channel; keeping it standardized lets sinks choose to ignore or consume it without changing producers.

### func (*Publisher) PublishPoolSnapshot

**Symbols:** PublishPoolSnapshot

```go title="func (*Publisher) PublishPoolSnapshot" file=<rootDir>/sinks/nats/publisher.go#L82-L90 showLineNumbers
```

**What:** Publishes pool snapshot updates (current state) to `<subjectRoot>.pool.snapshot`.

**How:** Uses `slot + pool_id` as the message ID and delegates to `publish(...)`.

**Why:** Pool snapshots can be used to materialize a current pool-state table without re-reading raw accounts.

### func (*Publisher) PublishCandle

**Symbols:** PublishCandle

```go title="func (*Publisher) PublishCandle" file=<rootDir>/sinks/nats/publisher.go#L92-L104 showLineNumbers
```

**What:** Publishes a candle message to `<subjectRoot>.candle.<scope>.<timeframe>`.

**How:** Determines scope from whether `pool_id` is set, then constructs subject and message ID before calling `publish(...)`.

**Why:** Candles are derived/aggregated events; consistent subject routing makes it easy to subscribe to “all 1m candles” or “pool-scoped candles only”.

### func (*Publisher) publish

**Symbols:** publish

```go title="func (*Publisher) publish" file=<rootDir>/sinks/nats/publisher.go#L106-L134 showLineNumbers
```

**What:** Shared implementation for marshaling a protobuf message and publishing it to JetStream.

**How:**

1. Marshal with `proto.Marshal`.
2. Build a `nats.Msg` and set headers:
   - `Nats-Msg-Id` (when provided) enables JetStream de-duplication.
   - `Content-Type` identifies protobuf payloads.
3. Ensure a timeout via `ensureTimeout`.
4. Publish synchronously with:
   - `nats.ExpectStream(p.cfg.Stream)` to prevent accidental cross-stream publishes.
5. Validate the server ack (if present) matches the expected stream.

**Why:** This is where the repo encodes its “publish contract”: correct stream, bounded latency, deterministic IDs, and explicit content type.

### func (*Publisher) ensureTimeout

**Symbols:** ensureTimeout

```go title="func (*Publisher) ensureTimeout" file=<rootDir>/sinks/nats/publisher.go#L136-L144 showLineNumbers
```

**What:** Ensures publish operations have a deadline.

**How:** If the parent context already has a deadline (or `PublishTimeout <= 0`), it is reused; otherwise a derived context with timeout is created.

**Why:** Bounded publish latency prevents stuck producers (and helps ensure shutdown paths complete).

### func (*Publisher) Config

**Symbols:** Config

```go title="func (*Publisher) Config" file=<rootDir>/sinks/nats/publisher.go#L146-L149 showLineNumbers
```

**What:** Returns a copy of the publisher’s configuration.

**How:** Simple getter; returns by value.

**Why:** Useful for tests and for debugging/logging current configuration.

### func (*Publisher) WithTimeout

**Symbols:** WithTimeout

```go title="func (*Publisher) WithTimeout" file=<rootDir>/sinks/nats/publisher.go#L151-L154 showLineNumbers
```

**What:** Public wrapper for the internal timeout helper.

**How:** Delegates to `ensureTimeout`.

**Why:** Exposes the same timeout semantics for external code paths that want to mirror publisher behavior.

### var (programSubjectAliases)

**Symbols:** programSubjectAliases

```go title="var (programSubjectAliases)" file=<rootDir>/sinks/nats/publisher.go#L156-L160 showLineNumbers
```

**What:** Maps well-known Solana program IDs to stable, human-readable subject segments.

**How:** `programSegment` looks up program IDs here before falling back to sanitization/truncation.

**Why:** Stable subject segments are ergonomic and avoid leaking raw program IDs into every subject string.

### func programSegment

**Symbols:** programSegment

```go title="func programSegment" file=<rootDir>/sinks/nats/publisher.go#L162-L180 showLineNumbers
```

**What:** Converts a program ID into a safe subject path segment.

**How:** The function:

1. Returns `"unknown"` for empty IDs.
2. Uses a stable alias when available.
3. Otherwise removes unsafe characters (e.g. `.`, spaces, wildcards) and lowercases/truncates to keep subjects small.

**Why:** Subjects are a routing API. Sanitization ensures malicious/invalid program IDs can’t create surprising subject patterns (like injecting wildcards).
